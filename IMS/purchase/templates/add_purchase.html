{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% block content %}
<div class="main-content">
  <div class="container mt-4">
    <div class="card shadow-lg p-4 rounded-3">
      <h2 class="mb-4 text-center">Add Purchase</h2>
        {% include "includes/alerts.html" %}
      <form method="post">
        {% csrf_token %}
        {{ formset.management_form }}
        <!-- Supplier & Invoice Info -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="supplier" class="form-label">Supplier</label>
            {{ form.supplier }}
          </div>
          <div class="col-md-6">
            <label for="invoice_no" class="form-label">Invoice No</label>
            {{ form.invoice_no }}
          </div>
        </div>

        <div class="row mb-4">
          <div class="col-md-4">
            <label for="vat_no" class="form-label">VAT Number</label>
            <input type="text" class="form-control" id="vat_no" name="vat_no" {% if data %}value={{data.vat_no}} {% endif %} readonly />
          </div>
          <div class="col-md-4">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="phone" name="phone" {% if data %}value={{data.phone}} {% endif %} readonly />
          </div>
          <div class="col-md-4">
            <label for="address" class="form-label">Address</label>
            <input class="form-control" id="address" name="address" rows="3" {% if data %}value="{{data.address}}"" {% endif %} readonly />
          </div>
        </div>

        <!-- Products Table -->
        <h5 class="mt-4 mb-3">Products</h5>
        <table class="table table-bordered" id="products-table">
          <thead class="table-light">
            <tr>
              <th style="width: 50px">S.No</th>
              <th style="width: 250px">Product</th>
              <th>Size</th>
              <th>Length(inch)</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for f in formset %}
            <tr>
              <td>{{ forloop.counter  }}</td>
              <td>{{ f.product |attr:"class:form-control product-input " }}</td>
              <td>{{ f.size |attr:"class:form-control size-input" }}</td>
              <td>{{ f.length |attr:"class:form-control length-input" }}</td>
              <td>{{ f.qty |attr:"class:form-control qty-input"}}</td>
              <td>{{ f.price |attr:"class:form-control price-input"}}</td>
              <td>{{ f.total |attr:"class:form-control total-input"}}</td>
              <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <button type="button" id="add-product" class="btn btn-secondary mb-4">Add Product</button>

        <!-- Grand Total -->
     <div class="mb-4">
            <div class="row mb-2 justify-content-end align-items-center">
                <div class="col-4 text-end">
                <label class="form-label fw-semibold">Grand Total:</label>
                </div>
                <div class="col-auto">
                <input type="number" name="grand_total" class="form-control rounded-3"  value="{% if data %}{{ data.grand_total }}{% endif %}" readonly />
                </div>
            </div>

            <div class="row mb-2  justify-content-end align-items-center">
                <div class="col-4 text-end">
                <label class="form-label fw-semibold">VAT (13%):</label>
                </div>
                <div class="col-auto">
                <input type="number" name="VAT" class="form-control rounded-3"  value="{% if data %}{{ data.VAT }}{% endif %}" readonly />
                </div>
            </div>

            <div class="row mb-2 justify-content-end align-items-centerr">
                <div class="col-4 text-end">
                <label class="form-label fw-semibold">Total Amount:</label>
                </div>
                <div class="col-auto">
                <input type="number" name="total_amount" class="form-control rounded-3"   value="{% if data %}{{ data.total_amount }}{% endif %}" readonly />
                </div>
            </div>
        </div>
        <!-- Submit Button -->
        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg">Save Purchase</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function updateTotalRows() {
    const rows = document.querySelectorAll("#products-table tbody tr").length;
    document.getElementById("total_rows").value = rows;
}

function attachAutocomplete(row) {
    const productInput = row.querySelector("input[name$='-product']");
    const sizeInput = row.querySelector("input[name$='-size']");
    const lengthInput = row.querySelector("input[name$='-length']");
    const qtyInput = row.querySelector("input[name$='-qty']");
    const priceInput = row.querySelector("input[name$='-price']");
    const totalInput = row.querySelector(".total-input");

    // PRODUCT AUTOCOMPLETE
    $(productInput).autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "/purchase/get_products/",
                data: { q: request.term },
                success: function(data) {
                    response(data.map(item => ({ label: item.product_name, value: item.product_name, id: item.id })));
                }
            });
        },
        minLength: 0
    }).focus(function() { $(this).autocomplete("search", ""); })
      .on("autocompleteselect", function(event, ui) {
          const product_id = ui.item.id;
          sizeInput.value = '';
          lengthInput.value = '';

          // SIZE AUTOCOMPLETE
          $(sizeInput).autocomplete({
              source: function(request, response) {
                  $.ajax({
                      url: `/purchase/get_sizes/`,
                      data: { q: request.term },
                      success: function(data) {
                          response(data.map(item => ({ label: item.size, value: item.size, id: item.id })));
                      }
                  });
              },
              minLength: 0
          }).focus(function() { $(this).autocomplete("search", ""); })
            .on("autocompleteselect", function(event, ui) {
                const size_id = ui.item.id;
                lengthInput.value = '';

                // LENGTH AUTOCOMPLETE
                $(lengthInput).autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: `/purchase/get_lengths/`,
                            data: { q: request.term },
                            success: function(data) {
                                response(data.map(item => ({ label: item.length_in_inch, value: item.length_in_inch })));
                            }
                        });
                    },
                    minLength: 0
                }).focus(function() { $(this).autocomplete("search", ""); });
            });
      });

    // CALCULATE TOTAL ON CHANGE
    [qtyInput, priceInput].forEach(input => {
        input.addEventListener("input", function() {
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            totalInput.value = (qty * price).toFixed(2);
            updateGrandTotal();
            checkFieldsTable(); // check button state on change
        });
    });

    // Also check button on product input
    productInput.addEventListener("input", checkFieldsTable);
}

// UPDATE GRAND TOTAL
function updateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll(".total-input:not([name='grand_total']):not([name='total_amount'])").forEach(input => {
        grandTotal += parseFloat(input.value) || 0;
    });

    document.querySelector("input[name='grand_total']").value = grandTotal.toFixed(2);

    let tax = grandTotal * 0.13;
    let total_amount = grandTotal + tax;

    document.querySelector("input[name='VAT']").value = tax.toFixed(2);
    document.querySelector("input[name='total_amount']").value = total_amount.toFixed(2);
}

// EMPTY SIZE AND LENGTH FIELDS
function checkEmptyFields() {
    document.querySelectorAll(".size-input, .length-input").forEach(input => {
        if (!input.value.trim()) {
            input.value = "----";
        }
    });
}

// TOGGLE PRODUCT FIELDS
function toggleProductFields() {
    const supplierSelect = document.querySelector('select[name="supplier"]');
    const invoiceSelect = document.querySelector('input[name="invoice_no"]');
    const disable = !supplierSelect.value || !invoiceSelect.value;

    document.querySelectorAll("#products-table tbody input").forEach(field => {
        field.disabled = disable;
    });

    checkFieldsTable(); // update add-product button state
}

// CHECK TABLE FIELDS AND ADD BUTTON
function checkFieldsTable() {
    const supplierSelect = document.querySelector('select[name="supplier"]');
    const invoiceSelect = document.querySelector('input[name="invoice_no"]');
    let disable = !supplierSelect.value || !invoiceSelect.value;

    const rows = document.querySelectorAll("#products-table tbody tr");
    rows.forEach(row => {
        
      const productInput = row.querySelector("input[name$='-product']");
       const qtyInput = row.querySelector("input[name$='-qty']");
       const priceInput = row.querySelector("input[name$='-price']");

        if (!productInput.value.trim() || !qtyInput.value.trim() || !priceInput.value.trim()) {
            disable = true;
        }
    });

    document.getElementById("add-product").disabled = disable;
}

// ATTACH AUTOCOMPLETE TO EXISTING ROWS
document.querySelectorAll("#products-table tbody tr").forEach(row => attachAutocomplete(row));

let totalFormsInput = document.getElementById('id_products-TOTAL_FORMS');
let counter = parseInt(totalFormsInput.value);
document.getElementById("add-product").addEventListener("click", function() {
    checkEmptyFields();
    const tbody = document.querySelector("#products-table tbody");
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${counter + 1}</td>
        <td><input type="text" name="products-${counter}-product" class="form-control product-input"></td>
        <td><input type="text" name="products-${counter}-size" class="form-control size-input" value="----"></td>
        <td><input type="text" name="products-${counter}-length" class="form-control length-input" value="----"></td>
        <td><input type="number" name="products-${counter}-qty" class="form-control" min="1" value="1"></td>
        <td><input type="number" name="products-${counter}-price" class="form-control" step="0.01"></td>
        <td><input type="text" name="products-${counter}-total" class="form-control total-input"  readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
    `;
    tbody.appendChild(row);

    attachAutocomplete(row);
    counter++;
    totalFormsInput.value = counter
    updateGrandTotal();
    toggleProductFields();
    checkFieldsTable();
});

// REMOVE ROW
document.addEventListener("click", function(e) {
    if (e.target && e.target.classList.contains("remove-row")) {
        e.target.closest("tr").remove();
        updateGrandTotal();
        checkFieldsTable(); // update button after removal
    }
});

// SUPPLIER INFO FETCH + INITIAL DISABLE
document.addEventListener("DOMContentLoaded", function() {
    const supplierSelect = document.querySelector('select[name="supplier"]');
    const invoiceSelect = document.querySelector('input[name="invoice_no"]');
    const vatInput = document.querySelector('input[name="vat_no"]');
    const phoneInput = document.querySelector('input[name="phone"]');
    const addressInput = document.querySelector('input[name="address"]');

    toggleProductFields();
    checkEmptyFields();
    checkFieldsTable();

    supplierSelect.addEventListener("change", function() {
        toggleProductFields();
        const supplierId = this.value;
        if (!supplierId) {
            vatInput.value = "";
            phoneInput.value = "";
            addressInput.value = "";
            return;
        }

        fetch(`/purchase/supplier_info/${supplierId}/`)
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    vatInput.value = data.vat_no;
                    phoneInput.value = data.phone;
                    addressInput.value = data.address;
                }
            })
            .catch(error => console.log(error));
    });

    invoiceSelect.addEventListener("input", toggleProductFields); 
});
</script>

{% endblock %}
